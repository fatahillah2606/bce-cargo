{% extends 'admin/base.html' %}

<!-- Title -->
{% block title %}Dashboard{% endblock %}

<!-- Style -->
{% block style %} {% endblock %}

<!-- Judul header -->
{% block judul %}Dashboard{% endblock %}
<!-- Konten -->
{% block konten %}
<div class="p-4">
    <!-- Ringkasan data -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Total Pesanan -->
        <div
            class="bg-white dark:bg-zinc-800 shadow rounded-xl p-4 flex items-center gap-4"
        >
            <span
                class="material-symbols-rounded text-4xl text-blue-500 dark:text-blue-400"
                >local_shipping</span
            >
            <div>
                <p class="text-sm text-zinc-500 dark:text-zinc-400">
                    Total Pesanan
                </p>
                <p
                    class="text-2xl font-bold text-zinc-800 dark:text-zinc-200"
                    id="total-pesanan"
                >
                    0
                </p>
            </div>
        </div>

        <!-- Sedang Dikirim -->
        <div
            class="bg-white dark:bg-zinc-800 shadow rounded-xl p-4 flex items-center gap-4"
        >
            <span
                class="material-symbols-rounded text-4xl text-yellow-500 dark:text-yellow-400"
                >delivery_dining</span
            >
            <div>
                <p class="text-sm text-zinc-500 dark:text-zinc-400">
                    Sedang Dikirim
                </p>
                <p
                    class="text-2xl font-bold text-zinc-800 dark:text-zinc-200"
                    id="dikirm"
                >
                    0
                </p>
            </div>
        </div>

        <!-- Selesai Terkirim -->
        <div
            class="bg-white dark:bg-zinc-800 shadow rounded-xl p-4 flex items-center gap-4"
        >
            <span
                class="material-symbols-rounded text-4xl text-green-500 dark:text-green-400"
                >check_circle</span
            >
            <div>
                <p class="text-sm text-zinc-500 dark:text-zinc-400">Terkirim</p>
                <p
                    class="text-2xl font-bold text-zinc-800 dark:text-zinc-200"
                    id="sampai"
                >
                    0
                </p>
            </div>
        </div>

        <!-- Pending -->
        <div
            class="bg-white dark:bg-zinc-800 shadow rounded-xl p-4 flex items-center gap-4"
        >
            <span
                class="material-symbols-rounded text-4xl text-red-500 dark:text-red-400"
                >receipt_long</span
            >
            <div>
                <p class="text-sm text-zinc-500 dark:text-zinc-400">Pending</p>
                <p
                    class="text-2xl font-bold text-zinc-800 dark:text-zinc-200"
                    id="pending"
                >
                    0
                </p>
            </div>
        </div>
    </div>

    <!-- Statistik -->
    <div class="bg-white dark:bg-zinc-800 shadow rounded-xl p-6 mb-6">
        <h2 class="text-lg font-semibold text-zinc-800 dark:text-zinc-200 mb-4">
            Total pesanan per bulan pada tahun <span id="tahun-ini"></span>
        </h2>
        <div class="w-full h-32 sm:h-56 lg:h-96">
            <!-- Jika data tidak tersedia -->
            <div
                class="hidden items-center p-4 mb-4 text-sm text-green-800 border border-green-300 rounded-lg bg-green-50 dark:bg-zinc-800 dark:text-green-400 dark:border-green-800"
                id="info-grafik"
            >
                <svg
                    class="shrink-0 inline w-4 h-4 me-3"
                    aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                >
                    <path
                        d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"
                    />
                </svg>
                <span class="sr-only">Info</span>
                <div>
                    <span class="font-medium">Grafik gagal ditampilkan!</span>
                    Tidak ada data yang dapat diproses
                </div>
            </div>

            <!-- Chart canvas -->
            <canvas id="pengirimanChart"></canvas>
        </div>
    </div>

    <!-- Tabel pesanan -->
    <div class="bg-white dark:bg-zinc-800 shadow rounded-xl p-6">
        <h2 class="text-lg font-semibold text-zinc-800 dark:text-zinc-200 mb-4">
            Riwayat Pesanan Terbaru
        </h2>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left text-zinc-600">
                <thead
                    class="text-xs text-zinc-500 dark:text-zinc-300 uppercase bg-zinc-100 dark:bg-zinc-700"
                >
                    <tr>
                        <th scope="col" class="px-4 py-3">Kode</th>
                        <th scope="col" class="px-4 py-3">Nama Pelanggan</th>
                        <th scope="col" class="px-4 py-3">Layanan</th>
                        <th scope="col" class="px-4 py-3">Status</th>
                        <th scope="col" class="px-4 py-3">Tanggal</th>
                        <th scope="col" class="px-4 py-3">Aksi</th>
                    </tr>
                </thead>
                <tbody
                    class="bg-white dark:bg-zinc-800 divide-y divide-zinc-200 dark:divide-zinc-800"
                    id="pesanan-terbaru"
                >
                    <tr>
                        <td colspan="6">
                            <p
                                class="text-center font-bold py-5"
                                id="info-pesanan-terbaru"
                            >
                                Memuat data terbaru...
                            </p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
<!-- Js per halaman -->
{% block kontenjs %}
<script>
    // variable
    const totalPesanan = document.getElementById("total-pesanan");
    const sedangDikirim = document.getElementById("dikirm");
    const sampaiTujuan = document.getElementById("sampai");
    const statusPending = document.getElementById("pending");

    // Minta data
    function muatDataTahunIni() {
        // fetch API
        const sekarang = new Date();
        fetch("/admin/api/data/pesanan?tahun=" + sekarang.getFullYear(), {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(async (respon) => {
                const data = await respon.json();
                if (!respon.ok) {
                    throw new Error(data.message);
                }
                return data;
            })
            .then((data) => {
                const listData = data.data;

                if (listData.length === 0) {
                    // Jika data tidak tersedia, tampilkan informasi
                    const infoGrafik = document.getElementById("info-grafik");
                    const infoPesananTerbaru = document.getElementById(
                        "info-pesanan-terbaru"
                    );

                    infoGrafik.classList.remove("hidden");
                    infoGrafik.classList.add("flex");

                    infoPesananTerbaru.textContent = "Data tidak tersedia.";
                } else {
                    // Proses chart
                    chartPesanan(hitungPesananPerBulanGMT7(listData));

                    // Proses data terbaru
                    pesananTerbaru(listData);
                }
            })
            .catch((error) => {
                tampilkanAlertKesalahan("An error occurred", error);
                console.error(error);
            });
    }

    function muatSemuaData() {
        fetch("/admin/api/data/pesanan", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(async (respon) => {
                const data = await respon.json();
                if (!respon.ok) {
                    throw new Error(data.message);
                }
                return data;
            })
            .then((data) => {
                // Proses datanya
                if (data.data.length === 0) {
                    //
                } else {
                    totalPesanan.textContent = data.pagination.total_items;
                    sedangDikirim.textContent = data.data.filter(
                        (item) => item.status === "Dalam pengiriman"
                    ).length;
                    sampaiTujuan.textContent = data.data.filter(
                        (item) =>
                            item.status === "Sampai tujuan" ||
                            item.status === "Selesai"
                    ).length;
                    statusPending.textContent = data.data.filter(
                        (item) => item.status === "Pending"
                    ).length;
                }
            })
            .catch((error) => {
                tampilkanAlertKesalahan("An error occurred", error);
                console.error(error);
            });
    }

    // Hitung pesanan perbulan
    function hitungPesananPerBulanGMT7(responData) {
        const hasil = new Array(12).fill(0); // Januariâ€“Desember = 12 elemen

        responData.forEach((item) => {
            const dateUTC = new Date(item.tanggal_pemesanan);

            // Konversi ke GMT+7
            const dateGMT7 = new Date(dateUTC.getTime() + 7 * 60 * 60 * 1000);

            // Ambil bulan sesuai GMT+7
            const bulan = dateGMT7.getMonth(); // 0 = Januari, 11 = Desember

            hasil[bulan]++;
        });

        return hasil;
    }

    // chart.js
    function chartPesanan(dataPerbulan) {
        const ctx = document.getElementById("pengirimanChart").getContext("2d");

        const pengirimanChart = new Chart(ctx, {
            type: "line", // Bisa ganti ke 'line'
            data: {
                labels: [
                    "Jan",
                    "Feb",
                    "Mar",
                    "Apr",
                    "Mei",
                    "Jun",
                    "Jul",
                    "Agu",
                    "Sep",
                    "Okt",
                    "Nov",
                    "Des",
                ],
                datasets: [
                    {
                        label: "Jumlah Pemesanan",
                        data: dataPerbulan,
                        backgroundColor: "rgba(34, 197, 94, 0.6)", // bg-green-500 semi
                        borderColor: "rgba(22, 163, 74, 1)", // green-600
                        borderWidth: 1,
                        borderRadius: 6,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                        },
                    },
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        backgroundColor: "#1e293b",
                        titleColor: "#fff",
                        bodyColor: "#fff",
                    },
                },
            },
        });
    }

    // Label warna untuk status pesanan
    function labelWarna(statusPesanan) {
        switch (statusPesanan) {
            case "Pending":
                return "bg-yellow-500";
            case "Diproses":
                return "bg-blue-500";
            case "Ditolak":
                return "bg-red-500";
            case "Menunggu pick-up":
                return "bg-orange-500";
            case "Dalam pengiriman":
                return "bg-indigo-500";
            case "Sampai tujuan":
                return "bg-teal-500";
            case "Selesai":
                return "bg-green-500";
            case "Gagal dikirim":
                return "bg-rose-500";
            default:
                return "bg-zinc-500"; // fallback warna default
        }
    }

    // Tabel pesanan terbaru
    function pesananTerbaru(datanya) {
        const elmTabelPesanan = document.getElementById("pesanan-terbaru");
        let tabelPesanan = "";

        datanya.forEach((tiapData) => {
            let tanggalPemesanan = formatTanggalGMT7(
                tiapData.tanggal_pemesanan
            );
            tabelPesanan += `
                <tr>
                    <td
                        class="px-4 py-3 font-medium text-zinc-800 dark:text-zinc-200"
                    >
                        ${tiapData.kode_pemesanan}
                    </td>
                    <td class="px-4 py-3 dark:text-zinc-400">
                        ${tiapData.nama_pengirim}
                    </td>
                    <td class="px-4 py-3 dark:text-zinc-400">
                        ${tiapData.jenis_kargo}
                    </td>
                    <td class="px-4 py-3 dark:text-zinc-400">
                        <span
                            class="inline-block px-2 py-1 text-xs text-center font-semibold text-white ${labelWarna(
                                tiapData.status
                            )} rounded-full"
                        >
                            ${tiapData.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 dark:text-zinc-400">
                        ${tanggalPemesanan.tanggal}
                    </td>
                    <td class="px-4 py-3">
                        <a
                            href="/admin/detail_pesanan/${
                                tiapData.kode_pemesanan
                            }"
                            class="text-green-600 dark:text-green-400 hover:underline text-sm font-medium"
                            >Lihat</a
                        >
                    </td>
                </tr>
            `;
        });

        elmTabelPesanan.innerHTML = tabelPesanan;
    }

    // etc
    document.getElementById("tahun-ini").textContent = new Date().getFullYear();

    // Muat semua data
    muatDataTahunIni();
    muatSemuaData();
</script>

{% endblock %}
