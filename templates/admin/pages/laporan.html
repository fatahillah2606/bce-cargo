{% extends 'admin/base.html' %}

<!-- Title -->
{% block title %}Laporan Transaksi{% endblock %}

<!-- Style -->
{% block style %} {% endblock %}

<!-- Judul header -->
{% block judul %}Laporan Transaksi{% endblock %}
<!-- Konten -->
{% block konten %}
<div class="p-4">
    <div class="bg-white rounded-xl shadow p-6 mb-6">
        <h2 class="text-lg font-semibold text-zinc-800 mb-4">
            Filter Periode Transaksi
        </h2>
        <form
            class="grid md:grid-cols-3 gap-4 items-end"
            id="rentang"
            name="rentang"
        >
            <!-- Dari Tanggal -->
            <div>
                <label
                    for="startDate"
                    class="block text-sm font-medium text-zinc-700 mb-1"
                    >Dari Tanggal</label
                >
                <input
                    type="date"
                    id="startDate"
                    name="start_date"
                    class="w-full px-4 py-2 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                />
            </div>

            <!-- Sampai Tanggal -->
            <div>
                <label
                    for="endDate"
                    class="block text-sm font-medium text-zinc-700 mb-1"
                    >Sampai Tanggal</label
                >
                <input
                    type="date"
                    id="endDate"
                    name="end_date"
                    class="w-full px-4 py-2 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                />
            </div>

            <!-- Tombol Terapkan -->
            <div>
                <button
                    type="submit"
                    class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600"
                >
                    Terapkan
                </button>
            </div>
        </form>
    </div>

    <!-- Ringkasan statistik -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <!-- Total Pesanan -->
        <div class="bg-white rounded-xl shadow p-4">
            <p class="text-sm text-zinc-500">Total Pesanan</p>
            <h3 class="text-xl font-bold text-zinc-800 mt-2" id="total-pesanan">
                0
            </h3>
        </div>

        <!-- Total Invoice -->
        <div class="bg-white rounded-xl shadow p-4">
            <p class="text-sm text-zinc-500">Total Invoice Dibuat</p>
            <h3 class="text-xl font-bold text-zinc-800 mt-2" id="total-invoice">
                0
            </h3>
        </div>

        <!-- Total Pendapatan -->
        <div class="bg-white rounded-xl shadow p-4">
            <p class="text-sm text-zinc-500">Total Pendapatan</p>
            <h3
                class="text-xl font-bold text-zinc-800 mt-2"
                id="total-pendapatan"
            >
                Rp 0
            </h3>
        </div>

        <!-- Pelanggan Unik -->
        <div class="bg-white rounded-xl shadow p-4">
            <p class="text-sm text-zinc-500">Jumlah Pelanggan Unik</p>
            <h3
                class="text-xl font-bold text-zinc-800 mt-2"
                id="pelanggan-unik"
            >
                0
            </h3>
        </div>
    </div>

    <!-- Grafik transaksi -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
        <h2 class="text-lg font-semibold text-zinc-800 mb-4">
            Grafik Transaksi
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Line Chart: Pendapatan -->
            <div>
                <h3 class="text-sm font-medium text-zinc-700 mb-2">
                    Tren Pendapatan Harian (Rp)
                </h3>
                <div class="w-full max-w-full h-[250px]">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>

            <!-- Bar Chart: Jumlah Pesanan -->
            <div>
                <h3 class="text-sm font-medium text-zinc-700 mb-2">
                    Jumlah Pesanan Harian
                </h3>
                <div class="w-full max-w-full h-[250px]">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabel laporan -->
    <div class="bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-zinc-800">
                Detail Laporan Transaksi
            </h2>
            <div class="flex gap-2">
                <button
                    class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600"
                    onclick="exportTableToPDF('laporanTable')"
                >
                    Unduh PDF
                </button>
                <button
                    class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600"
                    onclick="exportTableToExcel('laporanTable')"
                >
                    Unduh Excel
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table
                class="min-w-full text-sm text-left text-zinc-700"
                id="laporanTable"
            >
                <thead class="text-xs text-zinc-500 uppercase bg-zinc-100">
                    <tr>
                        <th class="px-4 py-3">Kode Invoice</th>
                        <th class="px-4 py-3">Kode Pesanan</th>
                        <th class="px-4 py-3">Pelanggan</th>
                        <th class="px-4 py-3">Moda</th>
                        <th class="px-4 py-3">Tanggal</th>
                        <th class="px-4 py-3">Total</th>
                        <th class="px-4 py-3">Status</th>
                    </tr>
                </thead>
                <tbody
                    class="bg-white divide-y divide-zinc-200"
                    id="detail_laporan_pemesanan"
                >
                    {% for i in range(10) %}
                    <!-- Dummy row 2 -->
                    <tr>
                        <td class="px-4 py-3 font-medium text-zinc-800">
                            <div
                                class="h-5 bg-zinc-200 rounded w-28 dark:bg-zinc-700 animate-pulse"
                            ></div>
                        </td>
                        <td class="px-4 py-3">
                            <div
                                class="h-5 bg-zinc-200 rounded w-32 dark:bg-zinc-700 animate-pulse"
                            ></div>
                        </td>
                        <td class="px-4 py-3">
                            <div
                                class="h-5 bg-zinc-200 rounded w-24 dark:bg-zinc-700 animate-pulse"
                            ></div>
                        </td>
                        <td class="px-4 py-3">
                            <div
                                class="h-5 bg-zinc-200 rounded w-12 dark:bg-zinc-700 animate-pulse"
                            ></div>
                        </td>
                        <td class="px-4 py-3">
                            <div
                                class="h-5 bg-zinc-200 rounded w-20 dark:bg-zinc-700 animate-pulse"
                            ></div>
                        </td>
                        <td class="px-4 py-3">
                            <div
                                class="h-5 bg-zinc-200 rounded w-20 dark:bg-zinc-700 animate-pulse"
                            ></div>
                        </td>
                        <td class="px-4 py-3">
                            <div
                                class="h-5 bg-zinc-200 rounded-full w-24 dark:bg-zinc-700 animate-pulse"
                            ></div>
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Tambah baris lainnya sesuai data -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
<!-- Konten js -->
{% block kontenjs %}
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
    // Simpan chart instance global
    let lineChartInstance = null;
    let barChartInstance = null;
    let startDate;
    let endDate;

    // Warna status
    function warnaStatus(status) {
        return status == "Belum Dibayar" ? "bg-red-500" : "bg-green-500";
    }

    // Muat detail laporan transaksi
    function muatDetailLaporanTransaksi(dataPemesanan) {
        const laporanPemesananContainer = document.getElementById(
            "detail_laporan_pemesanan"
        );
        let laporanPemesanan = "";
        dataPemesanan.forEach((pemesanan) => {
            if (pemesanan.invoice) {
                laporanPemesanan += `
                    <tr>
                        <td class="px-4 py-3 font-medium text-zinc-800">
                            ${pemesanan.invoice.kode_invoice}
                        </td>
                        <td class="px-4 py-3">${pemesanan.kode_pemesanan}</td>
                        <td class="px-4 py-3">${pemesanan.nama_pengirim}</td>
                        <td class="px-4 py-3">${pemesanan.jenis_kargo}</td>
                        <td class="px-4 py-3">${
                            pemesanan.tanggal_pemesanan
                        }</td>
                        <td class="px-4 py-3">${pemesanan.harga_total}</td>
                        <td class="px-4 py-3">
                            <span
                                class="inline-block px-2 py-1 text-xs text-white ${warnaStatus(
                                    pemesanan.invoice.status_pembayaran
                                )} rounded-full"
                            >
                                ${pemesanan.invoice.status_pembayaran}
                            </span>
                        </td>
                    </tr>
                `;
            } else {
                laporanPemesanan += `
                    <tr>
                        <td class="px-4 py-3 font-medium text-zinc-800">
                            -
                        </td>
                        <td class="px-4 py-3">${pemesanan.kode_pemesanan}</td>
                        <td class="px-4 py-3">${pemesanan.nama_pengirim}</td>
                        <td class="px-4 py-3">${pemesanan.jenis_kargo}</td>
                        <td class="px-4 py-3">${pemesanan.tanggal_pemesanan}</td>
                        <td class="px-4 py-3">${pemesanan.harga_total}</td>
                        <td class="px-4 py-3">
                            -
                        </td>
                    </tr>
                `;
            }
        });
        laporanPemesananContainer.innerHTML = laporanPemesanan;
    }

    // Untuk membuat chart data
    async function generateChartData(startDate, endDate) {
        try {
            // Ambil data dari server (pastikan backend bisa filter pakai query start & end)
            const response = await fetch(
                `/admin/api/data/laporan?start=${startDate}&end=${endDate}`
            );
            const data = await response.json();

            const transactions = data.data;
            const summary = data.summary;

            if (transactions.length === 0) {
                throw new Error(data.message);
            }

            // Muat rangkuman
            document.getElementById("total-pesanan").textContent =
                summary.total_pesanan;
            document.getElementById("total-invoice").textContent =
                summary.total_invoice;
            document.getElementById(
                "total-pendapatan"
            ).textContent = `Rp. ${summary.total_pendapatan.toLocaleString(
                "id-ID"
            )}`;
            document.getElementById("pelanggan-unik").textContent =
                summary.pelanggan_unik;

            // Muat Detail laporan transaksi
            muatDetailLaporanTransaksi(transactions);

            // Hitung selisih hari
            const diffDays =
                (new Date(endDate) - new Date(startDate)) / (1000 * 3600 * 24);

            let groupedPendapatan = {};
            let groupedPesanan = {};
            let labels = [];

            if (diffDays <= 31) {
                // Group by DAY
                transactions.forEach((tx) => {
                    const day = new Date(
                        tx.tanggal_pemesanan
                    ).toLocaleDateString("id-ID", {
                        day: "2-digit",
                        month: "short",
                    });
                    groupedPendapatan[day] =
                        (groupedPendapatan[day] || 0) + tx.harga_total;
                    groupedPesanan[day] = (groupedPesanan[day] || 0) + 1; // 1 transaksi = 1 pesanan
                });
                labels = Object.keys(groupedPendapatan);
            } else if (diffDays <= 365) {
                // Group by MONTH
                transactions.forEach((tx) => {
                    const month = new Date(
                        tx.tanggal_pemesanan
                    ).toLocaleDateString("id-ID", {
                        month: "short",
                        year: "numeric",
                    });
                    groupedPendapatan[month] =
                        (groupedPendapatan[month] || 0) + tx.harga_total;
                    groupedPesanan[month] = (groupedPesanan[month] || 0) + 1;
                });
                labels = Object.keys(groupedPendapatan);
            } else {
                // Group by YEAR
                transactions.forEach((tx) => {
                    const year = new Date(tx.tanggal_pemesanan).getFullYear();
                    groupedPendapatan[year] =
                        (groupedPendapatan[year] || 0) + tx.harga_total;
                    groupedPesanan[year] = (groupedPesanan[year] || 0) + 1;
                });
                labels = Object.keys(groupedPendapatan);
            }

            return {
                labels: labels,
                pendapatan: Object.values(groupedPendapatan),
                pesanan: Object.values(groupedPesanan),
            };
        } catch (error) {
            tampilkanAlertKesalahan("Gagal memuat data laporan", error);
            console.error("Gagal memuat data laporan:", error);
            return { labels: [], pendapatan: [], pesanan: [] };
        }
    }

    async function renderCharts(startDate, endDate) {
        const chartData = await generateChartData(startDate, endDate);

        // Hapus chart lama kalau ada
        if (lineChartInstance) {
            lineChartInstance.destroy();
        }
        if (barChartInstance) {
            barChartInstance.destroy();
        }

        console.log(chartData);

        if (chartData.labels.length === 0) {
            alert("Tidak ada data pada periode ini");
            return;
        }

        // Line Chart - Pendapatan
        lineChartInstance = new Chart(document.getElementById("lineChart"), {
            type: "line",
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: "Pendapatan",
                        data: chartData.pendapatan,
                        borderColor: "rgb(34 197 94)",
                        fill: false,
                        tension: 0.3,
                    },
                ],
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        ticks: {
                            callback: (value) => "Rp " + value.toLocaleString(),
                        },
                    },
                },
            },
        });

        // Bar Chart - Pesanan
        barChartInstance = new Chart(document.getElementById("barChart"), {
            type: "bar",
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: "Pesanan",
                        data: chartData.pesanan,
                        backgroundColor: "rgb(59 130 246)",
                    },
                ],
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 },
                    },
                },
            },
        });
    }

    document.querySelector("#rentang").addEventListener("submit", function (e) {
        e.preventDefault();

        startDate = document.getElementById("startDate").value;
        endDate = document.getElementById("endDate").value;

        if (startDate && endDate) {
            renderCharts(startDate, endDate);
        } else {
            alert("Silakan pilih rentang tanggal dulu!");
        }
    });

    // Muat data saat halaman selesai dimuat
    // Saat halaman dimuat → render bulan berjalan
    window.addEventListener("load", () => {
        const now = new Date();
        startDate = new Date(now.getFullYear(), now.getMonth(), 1) // hari pertama bulan
            .toISOString()
            .split("T")[0];
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0) // hari terakhir bulan
            .toISOString()
            .split("T")[0];

        // Set nilai default di input date biar user lihat periodenya
        document.getElementById("startDate").value = startDate;
        document.getElementById("endDate").value = endDate;

        // Render chart default
        renderCharts(startDate, endDate);
    });

    // SheetJS
    function exportTableToExcel(
        tableID,
        filename = `Laporan ${startDate} - ${endDate}.xlsx`
    ) {
        let table = document.getElementById(tableID);
        let wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
        XLSX.writeFile(wb, filename);
    }

    // jsPDF
    function exportTableToPDF(
        tableID,
        filename = `Laporan ${startDate} - ${endDate}.xlsx`
    ) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text("Detail Laporan Transaksi", 14, 16);
        doc.autoTable({ html: "#" + tableID, startY: 20 });

        doc.save(filename);
    }
</script>
{% endblock %}
