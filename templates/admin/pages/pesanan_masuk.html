{% extends 'admin/base.html' %}

<!-- Title -->
{% block title %}Pesanan masuk{% endblock %}

<!-- Style -->
{% block style %}
<link
    rel="stylesheet"
    href="{{url_for('static',filename='css/admin/dashboard.css')}}"
/>
{% endblock %}

<!-- Judul header -->
{% block judul %}Pesanan masuk{% endblock %}
<!-- Konten -->
{% block konten %}
<div class="p-5">
    <!-- Container utama -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
        <!-- Navigasi Tab -->
        <div class="mb-6 border-b border-gray-200">
            <div class="flex gap-2 text-sm font-medium text-gray-500">
                <a
                    href="/admin/pesanan_masuk"
                    class="relative px-4 py-2 text-green-600 font-semibold after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-full after:bg-green-500"
                >
                    Pesanan Masuk
                </a>
                <a
                    href="/admin/riwayat_pesanan"
                    class="px-4 py-2 hover:text-green-600 transition"
                >
                    Riwayat Pesanan
                </a>
                <a
                    href="/admin/status"
                    class="px-4 py-2 hover:text-green-600 transition"
                >
                    Status Pengiriman
                </a>
            </div>
        </div>

        <!-- List Pesanan Masuk -->
        <div class="space-y-4" id="pesanan-masuk">
            <p
                class="text-center font-bold text-gray-600"
                id="info-pesanan-masuk"
            >
                Memuat pesanan terbaru...
            </p>
        </div>
    </div>
</div>

<!-- Modal -->
<!-- Overlay + Modal Wrapper -->
<div
    id="modalPesanan"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50"
>
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-6 relative">
        <!-- Judul -->
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            Detail Pesanan - <span id="modalKode">BCE-U-240626-001</span>
        </h3>

        <!-- Isi Konten -->
        <div class="space-y-2 text-sm text-gray-700">
            <p>
                <strong>Nama Pelanggan:</strong>
                <span id="modalNama">Fajar Prasetyo</span>
            </p>
            <p>
                <strong>Layanan:</strong>
                <span id="modalLayanan">Kargo Darat</span>
            </p>
            <p><strong>Asal:</strong> <span id="modalAsal">Jakarta</span></p>
            <p>
                <strong>Tujuan:</strong> <span id="modalTujuan">Surabaya</span>
            </p>
            <p>
                <strong>Tanggal:</strong>
                <span id="modalTanggal">22 Juli 2025</span>
            </p>

            <!-- Input Nominal -->
            <div class="mt-4">
                <label
                    for="nominalInput"
                    class="block text-sm font-medium text-gray-600 mb-1"
                    >Nominal Harga (Rp)</label
                >
                <input
                    type="number"
                    id="nominalInput"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="Contoh: 150000"
                />
            </div>
        </div>

        <!-- Tombol Aksi -->
        <div class="mt-6 flex justify-end gap-2">
            <button
                onclick="terimaPesanan()"
                id="btnTerima"
                class="bg-green-500 text-white px-4 py-2 rounded-lg disabled:opacity-50"
                disabled
            >
                Terima
            </button>
            <button
                onclick="tolakPesanan()"
                class="bg-red-500 text-white px-4 py-2 rounded-lg"
            >
                Tolak
            </button>
            <button
                onclick="tutupModal()"
                class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg"
            >
                Tutup
            </button>
        </div>
    </div>
</div>

{% endblock %}
<!-- Js per halaman -->
{% block kontenjs %}
<script>
    // Variabel
    const pesananMasukContainer = document.getElementById("pesanan-masuk");
    let listPesanan = "";

    // Request data pesanan masuk
    function muatDataPesananMasuk() {
        // Fetch
        fetch("/admin/api/data/pesanan?status=Pending", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(async (respon) => {
                const data = await respon.json();
                if (!respon.ok) {
                    if (data.code === 404) {
                        // Jika tidak ada pesanan masuk
                        const infoPesananMasuk =
                            document.getElementById("info-pesanan-masuk");
                        infoPesananMasuk.textContent =
                            "Tidak ada pesanan masuk";

                        // Lempar error agar tidak di proses datanya
                        throw new Error(data.message || "Terjadi kesalahan");
                    } else {
                        throw new Error(data.message || "Terjadi kesalahan");
                    }
                }
                return data;
            })
            .then((data) => {
                data.data.forEach((pesananMasuk) => {
                    let tanggalPemesanan = formatTanggalGMT7(
                        pesananMasuk.tanggal_pemesanan
                    );
                    listPesanan += `
                        <div
                            class="flex items-start gap-4 bg-gray-50 border border-gray-200 shadow-sm rounded-lg p-4"
                        >
                            <span class="material-symbols-rounded text-green-600 text-3xl"
                                >local_shipping</span
                            >
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 mb-1">
                                    <span class="font-semibold text-gray-900"
                                        >${pesananMasuk.kode_pemesanan}</span
                                    >
                                    dari
                                    <span class="font-medium">${pesananMasuk.nama_pengirim}</span> meminta
                                    pengiriman <span class="italic">Kargo ${pesananMasuk.jenis_kargo}</span>.
                                </p>
                                <p class="text-xs text-gray-500">
                                    ${pesananMasuk.alamat_pengirim} → ${pesananMasuk.alamat_penerima} · ${tanggalPemesanan.tanggal}
                                </p>
                            </div>
                            <div>
                                <button
                                    class="text-sm px-3 py-1.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
                                    onclick="openModal('${pesananMasuk.kode_pemesanan}')"
                                >
                                    Lihat
                                </button>
                            </div>
                        </div>
                    `;
                });

                pesananMasukContainer.innerHTML = listPesanan;
            })
            .catch((error) => {
                console.error("Fetch error:", error);
            });
    }

    // Muat data pesanan masuk
    muatDataPesananMasuk();
</script>
{% endblock %}
